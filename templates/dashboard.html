{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<style>
  .chart-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
  <h3>Welcome, {{ user.name }}</h3>
  <small class="text-muted ms-md-3">Member since {{ user.created_at.strftime('%Y-%m-%d') }}</small>
</div>

<!-- Stats -->
<h5>Total checks</h5>
<div class="row mb-4">
  <div class="col-6 col-md-3 mb-3">
    <div class="card text-center shadow-lg border-success">
      <div class="card-body">
        <h5 class="card-title text-success">Healthy</h5>
        <p class="display-6">{{ healthy_count }}</p>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3 mb-3">
    <div class="card text-center shadow-lg border-warning">
      <div class="card-body">
        <h5 class="card-title text-danger">Diseased</h5>
        <p class="display-6">{{ diseased_count }}</p>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5>Recent Alerts</h5>
        {% if recent_alerts %}
          <ul class="list-group list-group-flush">
            {% for a in recent_alerts %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ a.disease }}
                <span class="badge bg-warning text-dark">{{ a.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No recent alerts.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Upload -->
<div class="card mb-4 shadow-lg">
  <div class="card-body">
    <h5>Upload leaf image for detection</h5>
    <form method="POST" enctype="multipart/form-data" onsubmit="showSpinner()">
      <div class="input-group">
        <input class="form-control" type="file" name="file" accept="image/*" required>
        <button class="btn btn-primary" type="submit">Upload & Detect</button> 
      </div>
    </form>
    <div class="mt-2 text-muted small">
      Alerts will be sent to: <strong>{{ user.email }}</strong> and <strong>{{ user.phone }}</strong>
    </div>

    <!-- Spinner -->
    <div id="loadingSpinner" class="text-center mt-3" style="display:none;">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Detecting...</span>
      </div>
      <p class="text-muted mt-2">Detecting disease, please wait...</p>
    </div>
  </div>
</div>

<!-- Chart Section -->
<div class="row mb-4 mt-5">
  <div class="col-12">
    <div class="card shadow-sm chart-card rounded-4 p-3">
      <div class="card-body">
        <h5 class="card-title">Detection Summary</h5>
        <canvas id="summaryChart" style="max-height:280px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card-shadow mb-4 mt-5 mb-4 shadow-sm">
  <div class="card-body">
    <h5>Filter past detections</h5>
    <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3 mt-1">
      <div class="col-md-3">
        <input type="text" class="form-control" name="crop" placeholder="Crop (e.g., Tomato)" value="{{ request.args.get('crop','') }}">
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" name="disease" placeholder="Disease (e.g., Blight)" value="{{ request.args.get('disease','') }}">
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" name="date_from" value="{{ request.args.get('date_from','') }}">
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" name="date_to" value="{{ request.args.get('date_to','') }}">
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-secondary text-dark w-50">Apply</button>
      </div>
    </form>
  </div>
</div>

<h5>Recent checks</h5>
<div class="row">
  {% for p in history %}
    {% set is_healthy = 'healthy' in p.disease.lower() %}
    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
      <div class="card h-100 {% if is_healthy %}border-success{% else %}border-warning{% endif %}">
        <img src="{{ p.image_path }}" 
             alt="Plant Image"
             class="img-fluid rounded shadow-sm"
             style="height: 180px; object-fit: fill;">
        <div class="card-body">
          <h6 class="card-title">{{ p.disease }}</h6>
          <p class="small mb-1">Certainty: {{ p.certainty }}%</p>
          <p class="small text-muted">Checked: {{ p.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
          {% if is_healthy %}
            <span class="badge bg-success">Healthy</span>
          {% else %}
            <span class="badge bg-warning text-dark">Attention</span>
          {% endif %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="col-12"><p class="text-muted">No checks found for selected filters.</p></div>
  {% endfor %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('summaryChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Healthy', 'Diseased'],
      datasets: [{
        label: 'Detections',
        data: [{{ healthy_count }}, {{ diseased_count }}],
        backgroundColor: ['rgba(25, 135, 84, 0.7)', 'rgba(255, 193, 7, 0.7)'],
        borderColor: ['rgb(25, 135, 84)', 'rgb(255, 193, 7)'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  function showSpinner() {
    document.getElementById("loadingSpinner").style.display = "block";
  }
</script>

{% endblock %}
